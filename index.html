<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Writing Companion - Class X</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #6c5ce7;
            --bg-pattern: #a29bfe;
            --glass-bg: #ffffff;
            --text-main: #2d3436;
            --btn-yellow: #f9d976;
            --accent-green: #00b894;
            --accent-red: #ff7675;
            --shadow: 8px 8px 0 rgba(0,0,0,0.15);
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--bg-pattern) 15%, transparent 15%);
            background-size: 25px 25px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%; max-width: 900px; background: var(--glass-bg);
            border: 3px solid var(--text-main); border-radius: 24px;
            box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column;
            height: 90vh;
            transition: filter 0.3s;
        }

        /* --- Header --- */
        .header {
            background: #dfe6e9; padding: 15px 25px; border-bottom: 3px solid var(--text-main);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: 900; font-size: 20px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .back-btn { 
            text-decoration: none; color: var(--text-main); font-weight: 700; font-size: 14px; 
            border: 2px solid var(--text-main); padding: 5px 15px; border-radius: 50px; 
            transition: 0.2s;
        }
        .back-btn:hover { background: var(--text-main); color: white; }

        /* --- Progress Bar --- */
        .progress-track { background: #f1f2f6; height: 10px; width: 100%; border-bottom: 3px solid var(--text-main); }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.5s ease; }

        /* --- Workspace --- */
        .workspace { display: flex; flex: 1; overflow: hidden; flex-direction: column; }
        @media (min-width: 768px) { .workspace { flex-direction: row; } }

        .task-panel {
            flex: 1; padding: 25px; background: #fab1a0; border-bottom: 3px solid var(--text-main); overflow-y: auto;
        }
        @media (min-width: 768px) { .task-panel { border-bottom: none; border-right: 3px solid var(--text-main); max-width: 35%; } }

        .task-tag { background: var(--text-main); color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 10px; }
        .task-title { font-weight: 800; font-size: 22px; margin-bottom: 10px; line-height: 1.3; }
        .task-desc { font-size: 14px; line-height: 1.6; color: var(--text-main); }
        
        .feedback-box {
            margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.6);
            border: 2px dashed var(--text-main); border-radius: 12px; font-size: 13px; display: none;
        }
        .feedback-box.success { background: #dff9fb; border-color: var(--accent-green); }
        .feedback-box.error { background: #ff7675; border-color: #d63031; color: white; }

        .editor-panel { flex: 2; display: flex; flex-direction: column; background: #fff; position: relative; }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-weight: 800; color: var(--text-main);
            text-align: center; padding: 20px;
        }

        textarea {
            flex: 1; width: 100%; border: none; padding: 30px;
            font-family: 'Courier Prime', monospace; font-size: 16px; line-height: 1.8;
            resize: none; outline: none; box-sizing: border-box;
            background-image: linear-gradient(#f1f2f6 1px, transparent 1px); background-size: 100% 32px;
        }

        .controls {
            padding: 15px 25px; background: white; border-top: 3px solid var(--text-main);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .word-count { font-size: 12px; font-weight: 700; color: #636e72; }
        .btn-action {
            background: var(--btn-yellow); color: var(--text-main); border: 2px solid var(--text-main);
            padding: 12px 24px; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 4px 4px 0 var(--text-main); transition: 0.1s;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-action:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-next { background: var(--accent-green); color: white; display: none; margin-top: 10px; width: 100%; }

        /* --- POPUP MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 30px;
            border-radius: 24px; border: 4px solid var(--text-main);
            box-shadow: 10px 10px 0 rgba(0,0,0,0.2); text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; color: var(--text-main); }
        .modal-text { font-size: 14px; line-height: 1.6; color: #636e72; margin-bottom: 25px; text-align: left; }
        .btn-start {
            background: var(--accent-green); color: white; border: 2px solid var(--text-main);
            width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 4px 4px 0 var(--text-main);
        }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--text-main); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="modal-overlay" id="welcome-modal">
        <div class="modal-box">
            <div class="modal-title">Writing Companion ‚úçÔ∏è</div>
            <div class="modal-text">
                <b>Master the Formal Letter (CBSE Class 10)</b><br><br>
                1Ô∏è‚É£ <b>Levels 1-4 (The Fixer):</b> The AI will write a broken letter. You must fix the Format & Tone.<br>
                2Ô∏è‚É£ <b>Level 5 (Final Boss):</b> Write a full letter from scratch based on a random topic.<br>
                3Ô∏è‚É£ <b>Infinite Practice:</b> Every question is unique!
            </div>
            <button class="btn-start" onclick="closeModal()">Start Learning ‚û§</button>
        </div>
    </div>

    <div class="app-container" id="app-container" style="filter: blur(5px);">
        <div class="header">
            <div class="brand">üìù Writing Companion</div>
            <a href="https://cbse-helper.vercel.app/" class="back-btn">Exit</a>
        </div>

        <div class="progress-track">
            <div class="progress-fill" id="progress-bar"></div>
        </div>

        <div class="workspace">
            <div class="task-panel">
                <span class="task-tag" id="level-badge">LEVEL 1</span>
                <h2 class="task-title" id="question-title">Loading...</h2>
                <p class="task-desc" id="question-desc">Generating your task...</p>

                <div class="feedback-box" id="ai-feedback">
                    <span id="feedback-text"></span>
                    <button class="btn-action btn-next" id="next-btn" onclick="nextLevel()">Next Challenge ‚û§</button>
                </div>
            </div>

            <div class="editor-panel">
                <div class="loading-overlay" id="loading-overlay">
                    <span class="spinner"></span>
                    <span>AI is writing a unique letter for you...</span>
                </div>
                <textarea id="letter-editor" spellcheck="false" placeholder="Start typing here..."></textarea>
            </div>
        </div>

        <div class="controls">
            <div class="word-count">Words: <span id="word-count">0</span></div>
            <button class="btn-action" id="check-btn" onclick="checkAnswer()">Check Answer ‚û§</button>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR NEW API KEY IS CONNECTED (WritingCompanion)
        const API_KEY = "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"; 

        // --- GLOBAL VARIABLES ---
        let currentLevel = 1;
        let currentTopic = "";
        let currentTaskType = "fix"; 
        
        const editor = document.getElementById('letter-editor');
        const title = document.getElementById('question-title');
        const desc = document.getElementById('question-desc');
        const badge = document.getElementById('level-badge');
        const feedbackBox = document.getElementById('ai-feedback');
        const feedbackText = document.getElementById('feedback-text');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const loadingOverlay = document.getElementById('loading-overlay');

        const topics = [
            "Irregular Water Supply", "Poor School Bus Facilities", "Rising Pollution in City", 
            "Enquiry about French Course", "Placing Order for Library Books", "Garbage on Streets", 
            "Frequent Power Cuts", "Complaint about Defective Mobile Phone", "Rash Driving by School Buses"
        ];

        function closeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
            document.getElementById('app-container').style.filter = 'none';
            generateLevel();
        }

        // --- GENERATOR LOGIC ---
        async function generateLevel() {
            // UI Reset
            loadingOverlay.style.display = 'flex';
            feedbackBox.style.display = 'none';
            checkBtn.style.display = 'block';
            nextBtn.style.display = 'none';
            editor.value = ""; 
            
            // Pick Random Topic
            const randomTopic = topics[Math.floor(Math.random() * topics.length)];
            currentTopic = randomTopic;

            // --- LEVEL 5: FINAL BOSS (WRITE FROM SCRATCH) ---
            if (currentLevel === 5) {
                currentTaskType = "write";
                badge.innerText = "LEVEL 5: FINAL BOSS";
                badge.style.background = "#d63031"; // Red
                title.innerText = "Write a Full Letter";
                
                desc.innerHTML = `<b>Topic:</b> ${randomTopic}<br><br>
                <b>Scenario:</b> You are Rahul/Riya, living at 123, ABC Colony. Write a formal letter (100-120 words) to the Editor regarding the topic.<br><br>
                <b>Strict Format Checklist:</b><br>
                1. Sender's Address & Date<br>
                2. Receiver's Address<br>
                3. Subject & Salutation<br>
                4. Body (3 Paras)<br>
                5. Closing & Signature`;

                editor.placeholder = "123, ABC Colony...\n\n7 February 2026\n\nThe Editor...\n\nSubject: ...";
                loadingOverlay.style.display = 'none'; // No AI generation needed for instructions
            
            } 
            // --- LEVELS 1-4: THE FIXER (AI GENERATES BROKEN LETTER) ---
            else {
                currentTaskType = "fix";
                badge.innerText = `LEVEL ${currentLevel}: THE FIXER`;
                badge.style.background = "#2d3436"; // Dark
                title.innerText = "Fix the Errors";
                desc.innerText = `The AI just wrote a letter about '${randomTopic}', but it messed up the Format and Tone. Can you fix it?`;

                // üß† AI CALL: CREATE BROKEN LETTER
                const systemPrompt = `You are a helper that generates 'Broken Letters' for students to fix. 
                TOPIC: ${randomTopic}.
                
                INSTRUCTIONS:
                Write a short formal letter body (40-50 words).
                INTENTIONALLY INCLUDE THESE MISTAKES:
                1. Use a very informal salutation (e.g., 'Dear Buddy', 'Hi Editor').
                2. Use the wrong date format (e.g., '12/05/24').
                3. Include one rude/angry sentence.
                
                OUTPUT ONLY THE LETTER TEXT. Do not add "Here is the letter".`;

                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [{ role: "system", content: systemPrompt }],
                            temperature: 0.8 // High creativity for broken letters
                        })
                    });
                    const data = await response.json();
                    
                    if(data.error) throw new Error(data.error.message);
                    
                    editor.value = data.choices[0].message.content;
                    loadingOverlay.style.display = 'none';
                    updateWordCount();

                } catch (error) {
                    console.error(error);
                    loadingOverlay.innerHTML = "<span style='color:red'>‚ö†Ô∏è AI Error. Check API Key.</span>";
                }
            }
        }

        // --- CHECKER LOGIC ---
        async function checkAnswer() {
            const studentText = editor.value;

            // üö´ ANTI-RUBBISH CHECK
            if(studentText.length < 10) {
                alert("Please write something before checking!");
                return;
            }

            checkBtn.innerText = "Grading...";
            checkBtn.disabled = true;
            feedbackBox.style.display = 'block';
            feedbackText.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:2px;"></span> Teacher is grading...';
            feedbackBox.className = 'feedback-box';

            let systemPrompt = "";

            if (currentTaskType === "write") {
                // STRICT CBSE GRADING PROMPT (Level 5)
                systemPrompt = `You are a strict CBSE Class 10 Examiner.
                TASK: Grade this Formal Letter about '${currentTopic}'.
                
                CHECKLIST (Max 5 Marks):
                1. Format (1 Mark): Sender Addr, Date, Receiver Addr, Subject, Salutation, Closing.
                2. Content (2 Marks): Is the issue explained clearly?
                3. Tone (1 Mark): Formal and polite?
                
                IMPORTANT: If the text is gibberish or spam, mark it as incorrect.

                OUTPUT JSON ONLY:
                {
                    "correct": true/false, (True if letter is good)
                    "score": "X/5",
                    "feedback": "2-3 sentences of specific feedback."
                }`;
            } else {
                // SIMPLE FIX CHECKER PROMPT (Levels 1-4)
                systemPrompt = `Teacher Mode. 
                TASK: The student tried to fix a broken letter about '${currentTopic}'.
                
                CHECK IF:
                1. Salutation is now formal (Sir/Madam/Editor).
                2. Date is now formal (e.g., 7 February 2026).
                3. The rude sentence was removed/fixed.
                4. The text makes sense (not gibberish).
                
                OUTPUT JSON ONLY: { "correct": true/false, "feedback": "Brief feedback on what they missed or got right." }`;
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `STUDENT TEXT:\n${studentText}` }
                        ],
                        temperature: 0.1,
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);

                checkBtn.innerText = "Check Answer ‚û§";
                checkBtn.disabled = false;

                if (result.correct === true) {
                    feedbackBox.className = 'feedback-box success';
                    const scoreText = result.score ? `<b>Score: ${result.score}</b><br>` : "";
                    feedbackText.innerHTML = `üéâ <b>Great Job!</b><br>${scoreText}${result.feedback}`;
                    checkBtn.style.display = 'none';
                    nextBtn.style.display = 'block';
                    
                    // Update Progress Bar
                    document.getElementById('progress-bar').style.width = `${currentLevel * 20}%`;
                } else {
                    feedbackBox.className = 'feedback-box error';
                    const scoreText = result.score ? `<b>Score: ${result.score}</b><br>` : "";
                    feedbackText.innerHTML = `‚ùå <b>Try Again.</b><br>${scoreText}${result.feedback}`;
                }

            } catch (error) {
                console.error(error);
                checkBtn.innerText = "Retry";
                checkBtn.disabled = false;
                feedbackText.innerText = "Error connecting to AI. Check API Key.";
            }
        }

        function nextLevel() {
            if (currentLevel < 5) {
                currentLevel++;
                generateLevel();
            } else {
                alert("üéâ Congratulations! You have mastered the Formal Letter!");
                location.href = "https://cbse-helper.vercel.app/";
            }
        }

        editor.addEventListener('input', updateWordCount);
        function updateWordCount() {
            const words = editor.value.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').innerText = words;
        }
    </script>
</body>
</html>
