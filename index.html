<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Writing Companion - Class X</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #6c5ce7;
            --bg-pattern: #a29bfe;
            --glass-bg: #ffffff;
            --text-main: #2d3436;
            --btn-yellow: #f9d976;
            --accent-green: #00b894;
            --accent-purple: #a29bfe;
            --accent-red: #ff7675;
            --shadow: 8px 8px 0 rgba(0,0,0,0.15);
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--bg-pattern) 15%, transparent 15%);
            background-size: 25px 25px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%; max-width: 900px; background: var(--glass-bg);
            border: 3px solid var(--text-main); border-radius: 24px;
            box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column;
            height: 90vh;
            transition: filter 0.3s;
        }

        /* --- Header --- */
        .header {
            background: #dfe6e9; padding: 15px 25px; border-bottom: 3px solid var(--text-main);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: 900; font-size: 20px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        
        .header-actions { display: flex; gap: 10px; }
        
        .header-btn { 
            text-decoration: none; color: var(--text-main); font-weight: 700; font-size: 13px; 
            border: 2px solid var(--text-main); padding: 5px 12px; border-radius: 50px; 
            transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 5px; background: white;
        }
        .header-btn:hover { background: var(--text-main); color: white; }
        .btn-guide { background: var(--btn-yellow); }

        /* --- Progress Bar --- */
        .progress-track { background: #f1f2f6; height: 10px; width: 100%; border-bottom: 3px solid var(--text-main); }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.5s ease; }

        /* --- Workspace --- */
        .workspace { display: flex; flex: 1; overflow: hidden; flex-direction: column; }
        @media (min-width: 768px) { .workspace { flex-direction: row; } }

        .task-panel {
            flex: 1; padding: 25px; background: #fab1a0; border-bottom: 3px solid var(--text-main); overflow-y: auto;
        }
        @media (min-width: 768px) { .task-panel { border-bottom: none; border-right: 3px solid var(--text-main); max-width: 35%; } }

        .task-tag { background: var(--text-main); color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 10px; }
        .task-title { font-weight: 800; font-size: 22px; margin-bottom: 10px; line-height: 1.3; }
        .task-desc { font-size: 14px; line-height: 1.6; color: var(--text-main); }
        
        .feedback-box {
            margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.6);
            border: 2px dashed var(--text-main); border-radius: 12px; font-size: 13px; display: none;
        }
        .feedback-box.success { background: #dff9fb; border-color: var(--accent-green); }
        .feedback-box.error { background: #ff7675; border-color: #d63031; color: white; }

        .editor-panel { flex: 2; display: flex; flex-direction: column; background: #fff; position: relative; }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-weight: 800; color: var(--text-main);
            text-align: center; padding: 20px;
        }

        textarea {
            flex: 1; width: 100%; border: none; padding: 30px;
            font-family: 'Courier Prime', monospace; font-size: 16px; line-height: 1.8;
            resize: none; outline: none; box-sizing: border-box;
            background-image: linear-gradient(#f1f2f6 1px, transparent 1px); background-size: 100% 32px;
        }

        .controls {
            padding: 15px 25px; background: white; border-top: 3px solid var(--text-main);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        
        .btn-group { display: flex; gap: 10px; align-items: center; }

        .word-count { font-size: 12px; font-weight: 700; color: #636e72; }
        
        .btn-action {
            background: var(--btn-yellow); color: var(--text-main); border: 2px solid var(--text-main);
            padding: 12px 20px; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer;
            box-shadow: 4px 4px 0 var(--text-main); transition: 0.1s;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-action:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; transform: none; }
        
        /* Button Variants */
        .btn-fix { background: var(--accent-purple); color: white; }
        .btn-skip { background: white; color: var(--text-main); border-style: dashed; }
        .btn-next { background: var(--accent-green); color: white; display: none; margin-top: 10px; width: 100%; }

        /* --- POPUP MODAL (GENERAL) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        
        .modal-box {
            background: white; width: 90%; max-width: 450px; padding: 30px;
            border-radius: 24px; border: 4px solid var(--text-main);
            box-shadow: 10px 10px 0 rgba(0,0,0,0.2); 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh; overflow-y: auto;
        }
        
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 15px; color: var(--text-main); text-transform: uppercase; }
        .modal-text { font-size: 14px; line-height: 1.6; color: #636e72; margin-bottom: 25px; text-align: left; }
        .btn-start {
            background: var(--accent-green); color: white; border: 2px solid var(--text-main);
            width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 4px 4px 0 var(--text-main);
        }

        /* --- FORMAT GUIDE STYLES --- */
        .guide-section { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        .guide-label { font-weight: 800; color: var(--text-main); display: block; margin-bottom: 4px; font-size: 12px; text-transform: uppercase; }
        .guide-example { font-family: 'Courier Prime', monospace; font-size: 13px; color: #444; background: #f1f2f6; padding: 8px; border-radius: 6px; }
        .example-letter { background: #fff8e1; padding: 15px; border: 2px solid var(--btn-yellow); border-radius: 12px; font-family: 'Courier Prime', monospace; font-size: 12px; white-space: pre-wrap; margin-top: 10px; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--text-main); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="modal-overlay" id="welcome-modal" style="display: flex;">
        <div class="modal-box" style="text-align: center;">
            <div class="modal-title">Writing Companion ‚úçÔ∏è</div>
            <div class="modal-text">
                <b>Master the Formal Letter (CBSE Class 10)</b><br><br>
                1Ô∏è‚É£ <b>Levels 1-4 (The Fixer):</b> The AI will write a broken letter. You must fix the Format & Tone.<br>
                2Ô∏è‚É£ <b>Level 5 (Final Boss):</b> Write a full letter from scratch based on a random topic.<br>
                3Ô∏è‚É£ <b>New Tools:</b> Use the <b>"Format Guide"</b> button anytime to see the rules!
            </div>
            <button class="btn-start" onclick="closeModal('welcome-modal')">Start Learning ‚û§</button>
        </div>
    </div>

    <div class="modal-overlay" id="guide-modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="modal-title" style="margin:0;">üìñ CBSE Format Guide</div>
                <button onclick="closeModal('guide-modal')" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-text" style="color: var(--text-main);">
                <div class="guide-section">
                    <span class="guide-label">1. Sender's Address</span>
                    <div class="guide-example">123, Thalayolaparambu,<br>Kerala - 686146</div>
                </div>
                <div class="guide-section">
                    <span class="guide-label">2. Date (Expanded Format)</span>
                    <div class="guide-example">7 February 2026</div>
                </div>
                <div class="guide-section">
                    <span class="guide-label">3. Receiver's Address</span>
                    <div class="guide-example">The Principal / The Editor,<br>Institution Name,<br>City - Zipcode</div>
                </div>
                <div class="guide-section">
                    <span class="guide-label">4. Subject & Salutation</span>
                    <div class="guide-example"><b>Subject:</b> Complaint about... (5-8 words)<br><br>Respected Sir/Madam,</div>
                </div>
                <div class="guide-section">
                    <span class="guide-label">5. Body Structure (3 Paras)</span>
                    <ul style="padding-left:15px; margin:5px 0; font-size:12px;">
                        <li><b>Para 1:</b> Introduction + Purpose</li>
                        <li><b>Para 2:</b> Details, causes, effects</li>
                        <li><b>Para 3:</b> Request action + Thanks</li>
                    </ul>
                </div>

                <div class="guide-section" style="border:none;">
                    <span class="guide-label">Example Letter:</span>
                    <div class="example-letter">123, Thalayolaparambu,
Kerala - 686146

7 February 2026

The Principal
St. Mary's School
Kottayam - 686001

Subject: Complaint regarding poor bus service

Respected Madam,

I am Rahul K., a Class 10 student of your school. I am writing to highlight the irregular bus service affecting students.

The buses arrive 30 minutes late daily, causing us to miss classes. Many students wait in remote areas without shelters. This has led to poor attendance and stress.

I request you to improve timings and add more buses. Thanking you in anticipation.

Yours sincerely,
Rahul K.
(Student, Class 10A)</div>
                </div>
                
                <button class="btn-start" onclick="closeModal('guide-modal')">Close Guide</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="app-container" style="filter: blur(5px);">
        <div class="header">
            <div class="brand">üìù Writing Companion</div>
            <div class="header-actions">
                <button class="header-btn btn-guide" onclick="openModal('guide-modal')">üìñ Format Guide</button>
                <a href="https://cbse-helper.vercel.app/" class="header-btn">Exit</a>
            </div>
        </div>

        <div class="progress-track">
            <div class="progress-fill" id="progress-bar"></div>
        </div>

        <div class="workspace">
            <div class="task-panel">
                <span class="task-tag" id="level-badge">LEVEL 1</span>
                <h2 class="task-title" id="question-title">Loading...</h2>
                <p class="task-desc" id="question-desc">Generating your task...</p>

                <div class="feedback-box" id="ai-feedback">
                    <span id="feedback-text"></span>
                    <button class="btn-action btn-next" id="next-btn" onclick="nextLevel()">Next Challenge ‚û§</button>
                </div>
            </div>

            <div class="editor-panel">
                <div class="loading-overlay" id="loading-overlay">
                    <span class="spinner"></span>
                    <span>AI is writing...</span>
                </div>
                <textarea id="letter-editor" spellcheck="false" placeholder="Start typing here..."></textarea>
            </div>
        </div>

        <div class="controls">
            <div class="word-count">Words: <span id="word-count">0</span></div>
            <div class="btn-group">
                <button class="btn-action btn-skip" onclick="skipLevel()">Next Question ‚è≠Ô∏è</button>
                <button class="btn-action btn-fix" id="fix-btn" onclick="autoFix()">‚ú® Correct it</button>
                <button class="btn-action" id="check-btn" onclick="checkAnswer()">Check Answer ‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR API KEY
        const API_KEY = "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"; 

        // --- GLOBAL VARIABLES ---
        let currentLevel = 1;
        let currentTopic = "";
        let currentTaskType = "fix"; 
        
        const editor = document.getElementById('letter-editor');
        const title = document.getElementById('question-title');
        const desc = document.getElementById('question-desc');
        const badge = document.getElementById('level-badge');
        const feedbackBox = document.getElementById('ai-feedback');
        const feedbackText = document.getElementById('feedback-text');
        const checkBtn = document.getElementById('check-btn');
        const fixBtn = document.getElementById('fix-btn');
        const nextBtn = document.getElementById('next-btn');
        const loadingOverlay = document.getElementById('loading-overlay');

        const topics = [
            "Irregular Water Supply", "Poor School Bus Facilities", "Rising Pollution in City", 
            "Enquiry about French Course", "Placing Order for Library Books", "Garbage on Streets", 
            "Frequent Power Cuts", "Complaint about Defective Mobile Phone", "Rash Driving by School Buses"
        ];

        // --- MODAL LOGIC ---
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if(id === 'welcome-modal') {
                document.getElementById('app-container').style.filter = 'none';
                generateLevel();
            }
        }

        // --- GENERATOR LOGIC ---
        async function generateLevel() {
            loadingOverlay.style.display = 'flex';
            feedbackBox.style.display = 'none';
            checkBtn.style.display = 'block';
            fixBtn.style.display = 'block';
            nextBtn.style.display = 'none';
            editor.value = ""; 
            
            const randomTopic = topics[Math.floor(Math.random() * topics.length)];
            currentTopic = randomTopic;

            if (currentLevel === 5) {
                currentTaskType = "write";
                badge.innerText = "LEVEL 5: FINAL BOSS";
                badge.style.background = "#d63031"; 
                title.innerText = "Write a Full Letter";
                desc.innerHTML = `<b>Topic:</b> ${randomTopic}<br>Write a formal letter (100-120 words) to the Editor.<br>Need help? Click <b>Format Guide</b> above!`;
                editor.placeholder = "123, Thalayolaparambu...\n\n7 February 2026\n\nThe Editor...\n\nSubject: ...";
                loadingOverlay.style.display = 'none'; 
            } else {
                currentTaskType = "fix";
                badge.innerText = `LEVEL ${currentLevel}: THE FIXER`;
                badge.style.background = "#2d3436"; 
                title.innerText = "Fix the Errors";
                desc.innerText = `The AI wrote a broken letter about '${randomTopic}'. Fix the format, date, and tone!`;

                const systemPrompt = `You create 'Broken Letters'. TOPIC: ${randomTopic}.
                Write a short formal letter body (40-50 words).
                INTENTIONALLY INCLUDE:
                1. Informal Salutation (e.g., 'Dear Buddy').
                2. Wrong Date (e.g., '12/05/24').
                3. One rude sentence.
                OUTPUT ONLY THE LETTER TEXT.`;

                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [{ role: "system", content: systemPrompt }],
                            temperature: 0.8
                        })
                    });
                    const data = await response.json();
                    editor.value = data.choices[0].message.content;
                    loadingOverlay.style.display = 'none';
                    updateWordCount();
                } catch (error) {
                    console.error(error);
                    loadingOverlay.innerHTML = "<span style='color:red'>‚ö†Ô∏è AI Error.</span>";
                }
            }
        }

        // --- CHECKER LOGIC ---
        async function checkAnswer() {
            const studentText = editor.value;
            if(studentText.length < 10) { alert("Please write something first!"); return; }

            checkBtn.innerText = "Grading...";
            checkBtn.disabled = true;
            fixBtn.disabled = true;
            feedbackBox.style.display = 'block';
            feedbackText.innerHTML = '<span class="spinner"></span> Grading...';
            feedbackBox.className = 'feedback-box';

            let systemPrompt = "";

            if (currentTaskType === "write") {
                systemPrompt = `You are a strict CBSE Class 10 Examiner.
                TASK: Grade this Formal Letter about '${currentTopic}'.
                CHECKLIST: Format (Sender, Date, Receiver, Subject, Salutation), Content, Tone.
                OUTPUT JSON: { "correct": true/false, "score": "X/5", "feedback": "Specific feedback." }`;
            } else {
                systemPrompt = `Teacher Mode. TASK: Did the student fix the broken letter about '${currentTopic}'?
                CHECK: Formal salutation? Formal date? Polite tone?
                OUTPUT JSON: { "correct": true/false, "feedback": "Brief feedback." }`;
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `STUDENT TEXT:\n${studentText}` }
                        ],
                        temperature: 0.1,
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);

                checkBtn.innerText = "Check Answer ‚û§";
                checkBtn.disabled = false;
                fixBtn.disabled = false;

                if (result.correct === true) {
                    feedbackBox.className = 'feedback-box success';
                    const scoreText = result.score ? `<b>Score: ${result.score}</b><br>` : "";
                    feedbackText.innerHTML = `üéâ <b>Great Job!</b><br>${scoreText}${result.feedback}`;
                    checkBtn.style.display = 'none';
                    fixBtn.style.display = 'none';
                    nextBtn.style.display = 'block';
                    document.getElementById('progress-bar').style.width = `${currentLevel * 20}%`;
                } else {
                    feedbackBox.className = 'feedback-box error';
                    const scoreText = result.score ? `<b>Score: ${result.score}</b><br>` : "";
                    feedbackText.innerHTML = `‚ùå <b>Try Again.</b><br>${scoreText}${result.feedback}`;
                }

            } catch (error) {
                console.error(error);
                checkBtn.innerText = "Retry"; checkBtn.disabled = false; fixBtn.disabled = false;
                feedbackText.innerText = "Connection Error.";
            }
        }

        // --- NEXT QUESTION LOGIC ---
        function skipLevel() {
            if(confirm("Skip this question?")) {
                nextLevel();
            }
        }

        function nextLevel() {
            if (currentLevel < 5) {
                currentLevel++;
                generateLevel();
            } else {
                alert("üéâ Congratulations! You have completed the Formal Letter Course!");
                location.href = "https://cbse-helper.vercel.app/";
            }
        }

        // --- STRICT AUTO FIX LOGIC ---
        async function autoFix() {
            if(!confirm("Rewriting will replace your text. Continue?")) return;
            loadingOverlay.style.display = 'flex';
            loadingOverlay.querySelector('span').nextElementSibling.innerText = "AI is writing the perfect letter...";
            
            // STRICT CBSE TEMPLATE FOR AI
            const strictTemplate = `
123, Thalayolaparambu,
Kerala - 686146

7 February 2026

The Editor / The Principal
[Institution/Newspaper]
[City - Zip]

Subject: [Subject regarding topic]

Respected Sir/Madam,

[Body Para 1: Intro]
[Body Para 2: Details]
[Body Para 3: Request]

Yours sincerely,
Rahul K.`;

            const systemPrompt = `You are a CBSE Topper. Write a PERFECT Formal Letter about '${currentTopic}'.
            IMPORTANT: YOU MUST USE THIS EXACT STRUCTURE:
            ${strictTemplate}
            
            Ensure the body is 100-120 words. No extra text.`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await response.json();
                editor.value = data.choices[0].message.content;
                loadingOverlay.style.display = 'none';
                updateWordCount();
                
                feedbackBox.style.display = 'block';
                feedbackBox.className = 'feedback-box success';
                feedbackText.innerHTML = "‚ú® <b>Fixed!</b> This is the perfect CBSE format. Study it closely!";

            } catch (error) {
                loadingOverlay.style.display = 'none';
                alert("Error connecting to AI.");
            }
        }

        editor.addEventListener('input', updateWordCount);
        function updateWordCount() {
            const words = editor.value.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').innerText = words;
        }
    </script>
</body>
</html>
